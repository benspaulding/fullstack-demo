---
version: "3.9"
name: fullstack-demo
include:
  - path: compose.common.yaml

# x-required:
#   - "${REPO_DIR:?Path to repository root in the container}"

x-code-mount:
  &__code_mount
  type: bind
  source: ..
  target: ${REPO_DIR:-/code}
x-vscode-home:
  &__vscode_home
  type: volume
  source: vscode-home-dir
  target: /home/app/.vscode-server
x-vscode-root:
  &__vscode_root
  type: volume
  source: vscode-root-dir
  target: /vscode

x-django:
  &__django_service
  build:
    context: ..
    dockerfile: .devcontainer/backend/Dockerfile
    target: dev
  env_file:
    - ../.env
    # - ../backend/.env
  volumes:
    - *__code_mount
    - *__vscode_home
    - *__vscode_root
  depends_on:
    - postgres-db
    - redis-db
  entrypoint:
    - ${VENV_DIR:-/venv}/bin/python
    - -m
    - djproj
  command:
    - --help

x-celery:
  &__celery_service
  <<: *__django_service
  volumes_from:
    - django-dev
  entrypoint:
    - ${VENV_DIR:-/venv}/bin/python
    - -m
    - celery
    - --app=${CELERY_APP:-djproj.celery:app}

x-next:
  &__next_service
  build:
    context: ..
    dockerfile: .devcontainer/frontend/Dockerfile
    target: dev
  env_file:
    - ../.env
    # - ../frontend/.env
  volumes:
    - *__code_mount
    - *__vscode_home
    - *__vscode_root
  depends_on:
    - django-dev
  entrypoint:
    - npm
  command:
    - --help

services:
  django-dev:
    <<: *__django_service
    command:
      - runserver
      - "${DJANGO_HOST:-0.0.0.0}:${DJANGO_PORT:-8000}"

    # # Runs app on the same network as the database container, allows "forwardPorts" in devcontainer.json function.
    # network_mode: service:postgres-db

    # Add "forwardPorts": ["8000"] to **devcontainer.json** to forward Django locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)
    ports:
      - published: ${DJANGO_PORT:-8000}
        target: 8000

  celery-worker:
    <<: *__celery_service
    command:
      - worker
      - --events
      - --concurrency=${CELERY_WORKER_CONCURRENCY:-1}
      - --queues=${CELERY_WORKER_QUEUES:-general,schedule}

  celery-beat:
    <<: *__celery_service
    command:
      - beat
      # - --scheduler=django_celery_beat.schedulers:DatabaseScheduler

  celery-flower:
    <<: *__celery_service
    command:
      - flower
      - --address=${FLOWER_HOST:-0.0.0.0}
      - --port=${FLOWER_PORT:-5555}

    # Add "forwardPorts": ["5555"] to **devcontainer.json** to forward Flower locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)
    ports:
      - published: ${FLOWER_PORT:-5555}
        target: 5555

  next-dev:
    <<: *__next_service
    command:
      - run
      - dev
      - -H ${NEXT_HOST:-0.0.0.0}
      - -p ${NEXT_PORT:-3000}

    # Add "forwardPorts": ["3000"] to **devcontainer.json** to forward next.js locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)
    ports:
      - published: ${NEXT_PORT:-3000}
        target: 3000

  storybook-dev:
    <<: *__next_service
    command:
      - run
      - dev:sb
      - -h ${STORYBOOK_HOST:-0.0.0.0}
      - -p ${STORYBOOK_PORT:-6006}
    volumes_from:
      - next-dev

    # Add "forwardPorts": ["6006"] to **devcontainer.json** to forward next.js locally.
    # (Adding the "ports" property to this file will not forward from a Codespace.)
    ports:
      - published: ${STORYBOOK_PORT:-6006}
        target: 6006

volumes:
  vscode-home-dir:
  vscode-root-dir:
